#!/bin/bash

. $HOME/etc/pkgmgr.conf
. $HOME/lib/common.sh
. $HOME/lib/pkgmgr/db
. $HOME/lib/pkgmgr/list
. $HOME/lib/pkgmgr/clean
. $HOME/lib/pkgmgr/actions

touch $LOCAL_DB_PATH
touch $REMOTE_DB_PATH
touch $VARLIB_PATH/info
mkdir -p $HOME/var/log
touch $LOG_PATH

#================#
# VARLIB_PATH    #
# PACKAGES_PATH  #
# LOCAL_DB_PATH  #
# REMOTE_DB_PATH #
# LOG_PATH       #
#================#

detect_os > /dev/null

function show_help(){
    echo "Usage : pkgmgr [OPTION]"
    echo "     install [PKGNAME]        ->  Install package"
    echo "     install-local [PKGPATH]  ->  Install local package"
    echo "     upgrade [PKGNAME]        ->  Upgrade package"
    echo "     remove [PKGNAME]         ->  Remove package"
    echo "     update                   ->  Update local database"
    echo "     list                     ->  List packages"
    echo "     clean                    ->  Clean cache"
    echo "     help                     ->  Print this help"
    exit 1
}

###############
###   RUN   ###
###############
ACTION=$1

if [[ "x$ACTION" =~ ^(xinstall|xinstall-local|xupgrade|xremove|xlist|xclean|xupdate)$ ]]; then
	if [[ "x$ACTION" = "xinstall" && $# -eq 2 ]]; then install_package $2 && exit $?; fi
	if [[ "x$ACTION" = "xinstall-local" && $# -eq 2 ]]; then install_local_package $2 && exit $?; fi
	if [[ "x$ACTION" = "xupgrade" && $# -eq 2 ]]; then upgrade_package $2 && exit $?; fi
	if [[ "x$ACTION" = "xremove" && $# -eq 2 ]]; then remove_package $2 && exit $?; fi
	if [[ "x$ACTION" = "xupdate" ]]; then update_db && exit $?; fi
	if [[ "x$ACTION" = "xlist" ]]; then create_view && exit $?; fi
	if [[ "x$ACTION" = "xclean" ]]; then clean_cache && exit $?; fi
	show_help
else
	show_help
fi
