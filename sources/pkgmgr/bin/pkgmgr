#!/bin/bash

. $HOME/etc/pkgmgr.conf
. $HOME/lib/common.sh
. $HOME/lib/pkgmgr/db
. $HOME/lib/pkgmgr/list
. $HOME/lib/pkgmgr/clean
. $HOME/lib/pkgmgr/actions
. $HOME/lib/pkgmgr/deps

touch $LOCAL_DB_PATH
touch $REMOTE_DB_PATH
touch $VARLIB_PATH/info
mkdir -p $HOME/var/log
touch $LOG_PATH

#================#
# VARLIB_PATH    #
# PACKAGES_PATH  #
# LOCAL_DB_PATH  #
# REMOTE_DB_PATH #
# LOG_PATH       #
#================#

detect_os > /dev/null

trap 'on_die' 1 2 3 4 5 6 7 8 10 12 13 14 15 20

on_die()
{
    echo "Wait..."
}

function show_help(){
    echo "Usage : pkgmgr [OPTION]"
    echo "   install [PKG]              ->  Install package(s)"
    echo "   install-local [PKGPATH]    ->  Install local package(s)"
    echo "   reinstall [PKG]            ->  Reinstall package(s)"
    echo "   reinstall-local [PKGPATH]  ->  Reinstall local package(s)"
    echo "   upgrade [PKG]              ->  Upgrade package(s)"
    echo "   remove [PKG]               ->  Remove package(s)"
    echo "   update                     ->  Update local database"
    echo "   list                       ->  List packages"
    echo "   clean                      ->  Clean cache"
    echo "   help                       ->  Print this help"
    exit 1
}

###############
###   RUN   ###
###############
ACTION=$1

if [[ "x$ACTION" =~ ^(xinstall|xreinstall|xinstall-local|xreinstall-local|xupgrade|xremove|xlist|xclean|xupdate)$ ]]; then
	if [ "x$ACTION" = "xinstall" ]; then 
		update_db
		tree=$(build_deps_tree ${@:2})
		install_package "$tree" && exit $?; fi
	if [ "x$ACTION" = "xreinstall" ]; then 
		update_db
		install_package "${@:2}" "_force" && exit $?; fi
	if [ "x$ACTION" = "xinstall-local" ]; then 
		tree=$(build_deps_tree ${@:2})
		install_local_package "$tree" && exit $?; fi
	if [ "x$ACTION" = "xreinstall-local" ]; then 
		install_local_package "${@:2}" "_force" && exit $?; fi
	if [ "x$ACTION" = "xupgrade" ]; then 
		update_db
		upgrade_package "${@:2}" && exit $?; fi
	if [ "x$ACTION" = "xremove"  ]; then 
		remove_package "${@:2}" && exit $?; fi
	if [ "x$ACTION" = "xupdate" ]; then 
		update_db && exit $?; fi
	if [ "x$ACTION" = "xlist" ]; then 
		create_view && exit $?; fi
	if [ "x$ACTION" = "xclean" ]; then 
		clean_cache && exit $?; fi
	show_help
else
	show_help
fi
