<!--
#--------------------------------
# Copyright (c) 2011 "Capensis" [http://www.capensis.com]
#
# This file is part of Canopsis.
#
# Canopsis is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Canopsis is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with Canopsis.  If not, see <http://www.gnu.org/licenses/>.
# ---------------------------------
-->
<html>
<head>
    	<title>Authentification</title>
	<link rel="stylesheet" type="text/css" href= "resources/lib/extjs/resources/css/ext-all.css">
	<link rel="stylesheet" type="text/css" href="themes/default/theme.css">
        <link rel="stylesheet" type="text/css" href="themes/canopsis/theme.css">

	<script type="text/javascript" src="resources/lib/extjs/ext-all.js"></script>
</head>
<body>

<div class='login'>
	<div class='header'></div>
	<div class='title'>Canopsis</div>
	<div class='layout'></div>
	<div id='form' class='form'>

	<script type="text/javascript">
		
		//function to return parameters in the url
		function getURLParameter(name) {
			return decodeURI(
				(RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
			);
		}
		
		Ext.require([
			'Ext.form.Panel',
			'Ext.util.KeyNav',
		]);

		Ext.onReady(function(){
			var winform = Ext.create('Ext.form.Panel', {
				url:'/auth',
				frame:true,
				id: 'my_form',
				submitOnEnter : true,
				title: 'Authentification',
				renderTo: 'form',
				fieldDefaults: {
					msgTarget: 'side',
					labelWidth: 75
				},
				defaultType: 'textfield',
				defaults: {
					anchor: '100%'
				},
		
				items: [{
					fieldLabel: 'Login',
					name: 'login',
					allowBlank:false
				},{
					fieldLabel: 'Password',
					name: 'password',
					inputType: 'password',
					allowBlank:false
				}],
				buttons: [{
					text: 'Login',
					id: 'submitbutton',
					submitOnEnter : true,
					handler: function() {
					var form = this.up('form').getForm(); // get the basic form
					if (form.isValid()) { // make sure the form contains valid data before submitting
						form.submit({
							method: 'GET',
							success: function(form, action) {
								var param = getURLParameter('url');	
								if(param != 'null'){
									window.location.href=param;
								} else {
									window.location.href='/';
								}
							},
							failure: function(form, action) {
								Ext.MessageBox.alert('authentification failed', 'login or password incorrect');
							}
						});
					} else { // display error alert if the data is invalid
						Ext.Msg.alert('Invalid Data', 'Please correct form errors.')
					}
				}
				}],			
			});
		
		var nav = Ext.create('Ext.util.KeyNav', Ext.getDoc(), {
			scope: 'my_form',
			enter: function(){
					if (winform.getForm().isValid()) { // make sure the form contains valid data before submitting
						winform.getForm().submit({
							method: 'GET',
							success: function(form, action) {
								var param = getURLParameter('url');	
								if(param != 'null'){
									window.location.href=param;
								} else {
									window.location.href='/';
								}
							},
							failure: function(form, action) {
								Ext.MessageBox.alert('authentification failed', 'login or password incorrect');
							}
						});
					} else { // display error alert if the data is invalid
						Ext.Msg.alert('Invalid Data', 'Please correct form errors.')
					}
			}
		})
		

		});

	</script>

	</div>
</div>

</body>
</html>
