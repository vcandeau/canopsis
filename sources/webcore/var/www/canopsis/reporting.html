<!--
#--------------------------------
# Copyright (c) 2011 "Capensis" [http://www.capensis.com]
#
# This file is part of Canopsis.
#
# Canopsis is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Canopsis is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with Canopsis.  If not, see <http://www.gnu.org/licenses/>.
# ---------------------------------
-->

<html>
<head>
    <title>Canopsis</title>
	<!-- Theme -->
	<link rel="stylesheet" type="text/css" href= "resources/lib/extjs/resources/css/ext-all.css">
	<!-- <link rel="stylesheet" type="text/css" href= "../RGraph/css/common.css"> -->
	<!--<link rel="stylesheet" type="text/css" href="resources/lib/jqplot/jquery.jqplot.min.css">-->
	<!-- <link rel="stylesheet" type="text/css" href="resources/css/ext-all.css"> -->
	<link rel="stylesheet" type="text/css" href="themes/default/theme.css">
	<link rel="stylesheet" type="text/css" href="themes/canopsis/theme.css">
	
	<link rel="stylesheet" type="text/css" href="resources/lib/jgauge/css/jgauge.css">

	<link rel="stylesheet" type="text/css" href="resources/lib/jquery-ui/themes/base/jquery.ui.all.css">
	<link rel="stylesheet" type="text/css" href="resources/lib/pnotify/jquery.pnotify.default.css">
	<link rel="stylesheet" type="text/css" href="resources/lib/pnotify/icons/jquery.pnotify.default.icons.css">

	<link rel="stylesheet" type="text/css" href="/ui/widgets.css">

</head>
<body style="width:940px;height:10px;">

	<!--<script type="text/javascript" src="resources/lib/extjs/ext.js"></script>-->
	<script type="text/javascript" src="resources/lib/extjs/ext-all.js"></script>
	
	<!-- Ext localization javascript -->
	<script type="text/javascript" id="extlocale"></script>
	<script type="text/javascript" id="canopsislocale"></script>

	<!-- Jquery -->
	<script type="text/javascript" src="resources/lib/jquery/jquery.min.js"></script>
	
	<script type="text/javascript" src="resources/lib/jgauge/js/excanvas.min.js"></script>
	<script type="text/javascript" src="resources/lib/jgauge/js/jQueryRotate.min.js"></script>
	<script type="text/javascript" src="resources/lib/jgauge/js/jgauge-0.3.0.a3.min.js"></script>

	<script type="text/javascript" src="resources/lib/pnotify/jquery.pnotify.min.js"></script>
	<script type="text/javascript" src="resources/lib/Highstock/js/highstock.src.js"></script>

	<!-- Application -->
	<script type="text/javascript" src="app/lib/global.js"></script>
	<script type="text/javascript" src="app/lib/log.js"></script>
	<script type="text/javascript" src="app/lib/tools.js"></script>
	<script type="text/javascript" src="app/lib/renderers.js"></script>
	<script type="text/javascript" src="app/lib/locale.js"></script>

	<!-- starting the reporting here -->
	<script type="text/javascript">
	if(!export_view_id){
		var decoded_url = Ext.urlDecode(window.location.search)
		var export_from = decoded_url.from
		var export_to = decoded_url.to
		var export_view_id = decoded_url.view
		log.debug('decoded_url.view : ' + decoded_url.view)
		log.debug('export_view_id : '+ export_view_id)
		log.debug('decoded_url.from : ' + decoded_url.from)
		log.debug('decoded_url.to : ' + decoded_url.to)
	}
		
		
	Ext.onReady(function() {
		Ext.Loader.setConfig({enabled:true});
		//global.account = 'root'
		
		log.debug('Check auth ...', "[app]");
		Ext.Ajax.request({
			type: 'rest',
			url: '/account/me',
			reader: {
				type: 'json',
				root: 'data',
				totalProperty  : 'total',
				successProperty: 'success'
			},
			success: function(response){
				request_state = Ext.JSON.decode(response.responseText).success
				if (request_state){
					global.account = Ext.JSON.decode(response.responseText).data[0];
					createApplication()
				} else {
					log.debug('unauthorized')
				}
			},
			failure: function() {
				log.debug('unauthorized')
			}
		});
		//createApplication()
	});

	//these are only for testing purpose
	//var export_view_id = 'view.root.test3';
	//var export_from = 1323990000000;
	//var export_to = 1324076400000;
	
	
	
	function createApplication(){
		log.debug("Loading locale ...", "[app]");
	
		var locale = global.account['locale']
		if (! locale){
			locale = global.default_locale;
		}
		log.debug(" + User locale: "+locale, "[app]");

		Ext.fly('extlocale').set({src:'resources/lib/extjs/locale/ext-lang-' + locale + '.js'});
		Ext.fly('canopsislocale').set({src:'resources/locales/lang-' + locale + '.js'});
		
		log.debug("Start ExtJS application ...", "[app]");
		var app = Ext.application({
			name: 'canopsis',
			appFolder: 'app',
			controllers: [
				'View',
				'ViewEditor',
				'Widgets',
			],
			launch: function() {
				this.getController('Widgets').on('loaded', this.createViewport);
			},
			createViewport: function(){
				reportViewport = Ext.create('Ext.container.Viewport');

				//pass reporting parameters
				var content = Ext.create('canopsis.view.ReportView',{
					view_id : export_view_id,
					//export_from : export_from,
					//export_to : export_to,
					autoshow : true,
					options : []});
				reportViewport.add(content);
			}
		});
		log.debug("Application started", "[app]");
	}
	</script>
	
</body>
</html>
