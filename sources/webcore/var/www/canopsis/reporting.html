<!--
#--------------------------------
# Copyright (c) 2011 "Capensis" [http://www.capensis.com]
#
# This file is part of Canopsis.
#
# Canopsis is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Canopsis is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with Canopsis.  If not, see <http://www.gnu.org/licenses/>.
# ---------------------------------
-->

<html>
<head>
    <title>Canopsis</title>
    
	<meta http-equiv="Cache-Control" content="no-cache">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">
    
	<!-- Theme -->
	<link rel="stylesheet" type="text/css" href= "resources/lib/extjs/resources/css/ext-all.css">
	<!-- <link rel="stylesheet" type="text/css" href= "../RGraph/css/common.css"> -->
	<!--<link rel="stylesheet" type="text/css" href="resources/lib/jqplot/jquery.jqplot.min.css">-->
	<!-- <link rel="stylesheet" type="text/css" href="resources/css/ext-all.css"> -->
	<link rel="stylesheet" type="text/css" href="themes/default/theme.css">
	<link rel="stylesheet" type="text/css" href="themes/canopsis/theme.css">
	
	<link rel="stylesheet" type="text/css" href="resources/lib/jgauge/css/jgauge.css">

	<link rel="stylesheet" type="text/css" href="resources/lib/jquery-ui/css/ui-lightness/jquery-ui-1.8.16.custom.css">
	
	<link rel="stylesheet" type="text/css" href="resources/lib/jqGridable/jqGridable.css">
	<link rel="stylesheet" type="text/css" href="resources/lib/pnotify/jquery.pnotify.default.css">
	<link rel="stylesheet" type="text/css" href="resources/lib/pnotify/icons/jquery.pnotify.default.icons.css">

	<link rel="stylesheet" type="text/css" href="/ui/widgets.css">

</head>
<body>
	
	<div id='container' style="height: 900px;"></div>

	<!--<script type="text/javascript" src="resources/lib/extjs/ext.js"></script>-->
	<script type="text/javascript" src="resources/lib/extjs/ext-all.js"></script>
	
	<!-- Ext localization javascript -->
	<script type="text/javascript" id="extlocale"></script>
	<script type="text/javascript" id="canopsislocale"></script>

	<!-- Jquery -->
	<script type="text/javascript" src="resources/lib/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="resources/lib/jquery-ui/jquery-ui-1.8.16.custom.min.js"></script>
	<script type="text/javascript" src="resources/lib/jqGridable/jqGridable.js"></script>
	
	<script type="text/javascript" src="resources/lib/jgauge/js/excanvas.min.js"></script>
	<script type="text/javascript" src="resources/lib/jgauge/js/jQueryRotate.min.js"></script>
	<script type="text/javascript" src="resources/lib/jgauge/js/jgauge-0.3.0.a3.min.js"></script>

	<script type="text/javascript" src="resources/lib/pnotify/jquery.pnotify.min.js"></script>
	<script type="text/javascript" src="resources/lib/Highstock/js/highstock.src.js"></script>

	<!-- Application -->
	<script type="text/javascript" src="app/lib/global.js"></script>
	<script type="text/javascript" src="app/lib/log.js"></script>
	<script type="text/javascript" src="app/lib/tools.js"></script>
	<script type="text/javascript" src="app/lib/renderers.js"></script>
	<script type="text/javascript" src="app/lib/locale.js"></script>

	<script type="text/javascript" src="resources/lib/jqGridable/jqGridable.Ext.js"></script>
	
	<!-- starting the reporting here -->
	<script type="text/javascript">
		
	log.debug('Start reporting')

	function on_failure(){
		log.error('Impossible deal with server')
	}

	function displayView(){
		log.debug("Loading locale ...", "[app]");
	
		var locale = global.account['locale']
		if (! locale){
			locale = global.default_locale;
		}
		log.debug(" + User locale: "+locale, "[app]");

		Ext.fly('extlocale').set({src:'resources/lib/extjs/locale/ext-lang-' + locale + '.js'});
		Ext.fly('canopsislocale').set({src:'resources/locales/lang-' + locale + '.js'});
		
		log.debug("Start ExtJS application ...", "[app]");
		
		var app = Ext.application({
			name: 'canopsis',
			appFolder: 'app',
			controllers: [
				'Widgets',
			],
			launch: function() {
				this.getController('Widgets').on('loaded', this.createView);
			},
			createView: function(){

				var content = Ext.create('canopsis.view.Tabs.Content',{
					renderTo: 'container',
					width: 940,
					view_id : export_view_id,
					
					reportMode : true,
					exportMode : true,
					export_from : export_from,
					export_to : export_to,
					
					//border: true,
					//debug: true,
					autoshow : true,
				});	
				
				var task = new Ext.util.DelayedTask(function(){
					window.status = 'ready'
				});
				task.delay(3000)
			}
		});
		log.debug("Application started", "[app]");
	}

		
	Ext.onReady(function() {
		Ext.Loader.setConfig({enabled:true});
		
		try {
			if(!export_view_id){
				log.debug('export_view_id is undefined')
			} else {
				log.debug('export_view_id is defined')
			}
		} catch(err) {
			var decoded_url = Ext.urlDecode(window.location.search)
			log.debug('Get options from URL ('+decoded_url+')')
			
			if(decoded_url.view != undefined){
				export_from = decoded_url.from
				export_to = decoded_url.to
				export_view_id = decoded_url.view
			} else {
				//these are only for testing purpose
				log.debug('no view specified, render dashboard')
				export_view_id = 'view._default_.dashboard';
				export_to = Date.now();
				export_from = export_to - (global.commonTs.day * 1000);
			}
		
		}
	
		log.debug(' + View Id: ' + export_view_id)
		log.debug(' + From: ' + export_from)
		log.debug(' + To: ' + export_to)
		
		Ext.Ajax.request({
			type: 'rest',
			url: '/account/me',
			reader: {
				type: 'json',
				root: 'data',
				totalProperty  : 'total',
				successProperty: 'success'
			},		
			success: function(response){
				var response = Ext.JSON.decode(response.responseText)
				if (response.success) {
					global.account = response.data[0]
					displayView()
				}else{
					log.debug('Auth failed')
					on_failure()
				}
			},
			failure: on_failure
		});
		
	});
	
	</script>
	
</body>
</html>
