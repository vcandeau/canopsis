#!/bin/bash
#param1: 

if [ "$1" == "-h" ]||[ "$1" == "-help" ]||[ $# -eq 0 ]
then

	echo "parameters are : javascript delay |  file name | view name | startTime | stopTime"

else

	#Test if serv X launch and variable exported
	if [ -e "/tmp/.X1-lock" ]
	then
		echo "X server already started (if not, delete /tmp/.X1-lock)"
	else
		echo "X server not already started"
		Xvfb :1 -screen 0 1024x768x24 &
	fi

	#Exporting env variable
	
	if [ "$DISPLAY" != "localhost:1" ]
	then
		echo "$DISPLAY"
		DISPLAY="127.0.0.1:1"
		export DISPLAY
		echo "$DISPLAY"
	fi
	
	#create report directory if didn't exist
	if [ ! -d "/opt/canopsis/tmp/report/" ]
	then
		mkdir "/opt/canopsis/tmp/report"
	fi
	
	#Get Cookie
	
	if [ -e "/opt/canopsis/tmp/cookies.wkhtmltopdf.txt" ]
	then
		rm /opt/canopsis/tmp/cookies.wkhtmltopdf.txt
	fi
	echo "set cookie"
	wkhtmltopdf --load-error-handling ignore --cookie-jar /opt/canopsis/tmp/cookies.wkhtmltopdf.txt "http://127.0.0.1:8082/auth/root/root" /dev/null
	
	#Build command line

	cookie_path="--cookie-jar /opt/canopsis/tmp/cookies.wkhtmltopdf.txt"
	js_delay="--javascript-delay $1"
	#js_script="--run-script \"$2\""
	server_url="http://127.0.0.1:8082/static/canopsis/reporting.html"
	file_path="/opt/canopsis/tmp/report/$2"
	
	header="--header-html /opt/canopsis/var/wkhtmltopdf/header.html"
	#header_command=""
	
	footer="--footer-html /opt/canopsis/var/wkhtmltopdf/footer.html"
	#footer_command="'Page [page] of [toPage]'
		
	js_script="var export_view_id='$3';var export_from=$4;var export_to=$5"
	js_command="--run-script"

	base_command="wkhtmltopdf --use-xserver --debug-javascript --load-error-handling ignore --disable-smart-shrinking "

	#command="$base_command $cookie_path  $js_delay $js_command $js_script $server_url $file_path"
	
	$base_command $cookie_path $js_delay $header $footer $js_command "`echo $js_script`" $server_url $file_path
	
	#$command

fi

exit
