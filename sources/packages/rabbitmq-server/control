#!/bin/bash

NAME="rabbitmq-server"
VERSION=2.7.0
RELEASE=0
DESCRIPTION=""
REQUIRES="canohome pkgmgr erlang"

function pre_install(){
	echo "Pre-install $NAME $VERSION-$RELEASE ..."
	check_code $? 
}

function post_install(){
	echo "Post-install $NAME $VERSION-$RELEASE ..."

	launch_cmd 1 service rabbitmq-server start

	echo "Safe wait ..."
	sleep 5

	CODE=0

	echo " + Declare Admin user ..."
	$PREFIX/bin/rabbitmqadmin -H 127.0.0.1 declare user name=admin password=admin tags=administrator
	RCODE=$?
	if [ $RCODE -ne 0 ]; then CODE=$RCODE; fi

	echo " + Declare vhost ..."
	$PREFIX/bin/rabbitmqadmin -H 127.0.0.1 declare vhost name=canopsis
	RCODE=$?
	if [ $RCODE -ne 0 ]; then CODE=$RCODE; fi

	echo " + Declare permissions for guest user ..."
	$PREFIX/bin/rabbitmqadmin -H 127.0.0.1 -V canopsis declare permission vhost=canopsis user=guest configure=".*" write=".*" read=".*"
	RCODE=$?
	if [ $RCODE -ne 0 ]; then CODE=$RCODE; fi

	launch_cmd 1 service rabbitmq-server stop

	check_code $CODE "Error in rabbitMQ configurations ..."
}

function pre_remove(){
	echo "Pre-remove $NAME $VERSION-$RELEASE ..."
	service rabbitmq-server stop 
}

function post_remove(){
	echo "Post-remove $NAME $VERSION-$RELEASE ..."
	check_code $?
}

function pre_update(){
	echo "Pre-update $NAME $VERSION-$RELEASE ..."
	check_code $?
}

function post_update(){
	echo "Post-update $NAME $VERSION-$RELEASE ..."
	check_code $?
}

function purge(){
	echo "Purge $NAME $VERSION-$RELEASE ..."
	rm -Rf $PREFIX/var/lib/rabbitmq
	rm -Rf $PREFIX/var/log/rabbitmq
}
