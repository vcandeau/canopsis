#!/bin/bash

NAME="mongodb"
VERSION=2.0.2
RELEASE=0
DESCRIPTION=""
REQUIRES="canohome pkgmgr python canolibs"

function pre_install(){
	echo "Pre-install $NAME $VERSION-$RELEASE ..."
	check_code $? 
}

function post_install(){
	echo "Post-install $NAME $VERSION-$RELEASE ..."
	mkdir -p $PREFIX/var/log/mongodb
	mkdir -p $PREFIX/var/lib/mongodb
	chown $HUSER -R $PREFIX/var/log/mongodb
	chown $HUSER -R $PREFIX/var/lib/mongodb
	
	launch_cmd 0 service mongodb stop
	
	rm /tmp/mongodb-*.sock &> /dev/null || true

	launch_cmd 1 service mongodb start

	## Wait mongo ready
	echo "Wait mongoDB (preallocating journal file...), You can take a coffee ..."
        i=0
        while [ `ls /tmp/mongodb-*.sock 2> /dev/null| wc -l || true` -eq 0 ]; do
                if [ $i -gt 1200 ]; then
                        echo 
                        echo "Timeout, Impossible to connect mongoDB ..."
                        exit 1
                fi
                i=$((i+1))
                echo -n "."
                sleep 0.5
        done
        echo

	launch_cmd 1 python $PREFIX/opt/mongodb/initDB.py
	launch_cmd 1 service mongodb stop

	check_code $? "Impossible to init mongoDB ..."
}

function pre_remove(){
	echo "Pre-remove $NAME $VERSION-$RELEASE ..."
	service mongodb stop
}

function post_remove(){
	echo "Post-remove $NAME $VERSION-$RELEASE ..."
}

function pre_update(){
	echo "Pre-update $NAME $VERSION-$RELEASE ..."
	check_code $?
}

function post_update(){
	echo "Post-update $NAME $VERSION-$RELEASE ..."
	check_code $?
}

function purge(){
	echo "Purge $NAME $VERSION-$RELEASE ..."
	rm -Rf $PREFIX/var/lib/mongodb
	rm -Rf $PREFIX/var/log/mongodb
}
