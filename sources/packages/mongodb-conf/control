#!/bin/bash

NAME="mongodb-conf"
VERSION=0.1
RELEASE=1
DESCRIPTION=""
REQUIRES="canohome pkgmgr python canolibs mongodb"

NO_ARCH=true
NO_DIST=true
NO_DISTVERS=true

function pre_install(){
	echo "Pre-install $NAME $VERSION-$RELEASE ..."
	check_code $? 
}

function post_install(){
	echo "Post-install $NAME $VERSION-$RELEASE ..."

	launch_cmd 0 service mongodb stop
		
	rm /tmp/mongodb-*.sock &> /dev/null || true
	
	#launch_cmd 1 service mongodb start
	launch_cmd 1 mongod -f $PREFIX/etc/mongodb.conf --nojournal --noprealloc --fork
	sleep 5

	#check if db already exist
	if [ -f  $PREFIX/var/lib/mongodb/canopsis.ns ]
	then
		launch_cmd 1 python $PREFIX/opt/mongodb/updateDB.py
	else
		launch_cmd 1 python $PREFIX/opt/mongodb/initDB.py
	fi
	
	#launch_cmd 1 service mongodb stop
	launch_cmd 1 mongod -f etc/mongodb.conf --shutdown 
	
	check_code $? "Impossible to init mongoDB ..."
}
	
function pre_remove(){
	echo "Pre-remove $NAME $VERSION-$RELEASE ..."
	service mongodb stop
}

function post_remove(){
	echo "Post-remove $NAME $VERSION-$RELEASE ..."
}

function pre_update(){
	echo "Pre-update $NAME $VERSION-$RELEASE ..."
	check_code $?
}

function post_update(){
	echo "Post-update $NAME $VERSION-$RELEASE ..."
	launch_cmd 1 python $PREFIX/opt/mongodb/updateDB.py
	check_code $?
}

function purge(){
	echo "Purge $NAME $VERSION-$RELEASE ..."
	check_code $?
}
